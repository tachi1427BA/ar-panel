<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AR Character Panel</title>
  <meta name="description" content="AR Character Panel using A-Frame and AR.js">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- A-Frameを読み込み -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <!-- AR.js for A-Frameを読み込み -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

  <style>
    /* ロード中のメッセージスタイル */
    #loading-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 24px;
      font-family: sans-serif;
      z-index: 1000;
      text-align: center;
    }
    .arjs-loader {
      height: 100%;
      width: 100%;
      position: absolute;
      top: 0;
      left: 0;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .arjs-loader-spinner {
      border: 16px solid #f3f3f3;
      border-top: 16px solid #3498db;
      border-radius: 50%;
      width: 120px;
      height: 120px;
      animation: spin 2s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>

<body style="margin : 0px; overflow: hidden;">
  <!-- AR.jsのローディング画面 -->
  <div class="arjs-loader">
    <div id="loading-message">
      カメラを起動し、周囲の環境を<br>ゆっくりスキャンしてください...
    </div>
  </div>

  <!--
    arjs: AR.jsの基本的な設定
      - sourceType: webcam (モバイルのカメラを使用)
      - trackingMethod: best (最適なトラッキング方法を自動選択)
      - debugUIEnabled: false (デバッグ用のUIを非表示)
    ar-hit-test: 平面を検出してオブジェクトを配置する機能
      - enabled: false (最初は無効化)
      - target: #character-panel (ヒットテストで動かすオブジェクト)
      - type: FOOTER (床や地面などの水平な平面を検出)
  -->
  <a-scene
    vr-mode-ui="enabled: false;"
    renderer="logarithmicDepthBuffer: true;"
    arjs="sourceType: webcam; trackingMethod: best; debugUIEnabled: false;"
    ar-hit-test="enabled: false; target: #character-panel; type: FOOTER;"
    gesture-detector
    id="scene"
  >
    <!-- アセット管理 -->
    <a-assets>
      <!-- キャラクター画像 (プレースホルダー) -->
      <img id="character-img" src="https://img.atwiki.jp/bluearchive/attach/62/66/%E3%82%AB%E3%83%A8%E3%82%B3.png">
    </a-assets>

    <!-- カメラ -->
    <a-camera
      gps-new-camera="gpsMinDistance: 5;"
      look-controls="magicWindowTrackingEnabled: false; touchEnabled: false; mouseEnabled: false"
    ></a-camera>

    <!--
      キャラクターパネル
      - visible: false (最初は非表示)
      - scale: 1.7 1.7 1.7 (約170cmの高さに調整)
      - material: src: #character-img (画像をテクスチャとして使用); transparent: true (透過を有効に)
    -->
    <a-entity
      id="character-panel"
      gltf-model=""
      position="0 -9999 0"
      visible="false"
    >
        <a-plane
            id="character-plane"
            height="1.7"
            width="0.85"
            material="src: #character-img; transparent: true; shader: flat;"
        ></a-plane>
    </a-entity>

  </a-scene>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const sceneEl = document.querySelector('a-scene');
      const characterPanel = document.querySelector('#character-panel');
      const loadingMessage = document.querySelector('#loading-message');

      // ARセッションの準備ができたときのイベント
      sceneEl.addEventListener('ar-session-start', () => {
        console.log("AR Session Started");
        // 平面検出を有効化
        sceneEl.setAttribute('ar-hit-test', { enabled: true });
        loadingMessage.textContent = '配置したい場所をタップしてください';
      });
      
      // 平面を検出したときのイベント
      sceneEl.addEventListener('ar-hit-test-start', () => {
        console.log("AR Hit Test Started (Surface Found)");
      });

      // 平面が見つからなくなったときのイベント
      sceneEl.addEventListener('ar-hit-test-achieved', () => {
        console.log("AR Hit Test Achieved");
      });
      
      // 平面検出が停止したときのイベント
      sceneEl.addEventListener('ar-hit-test-stop', () => {
        console.log("AR Hit Test Stopped (Surface Lost)");
      });

      // 画面をタップしたときのイベント
      sceneEl.addEventListener('click', (event) => {
        // ar-hit-testが有効な場合のみ処理
        if (sceneEl.getAttribute('ar-hit-test').enabled) {
          console.log("Screen tapped");
          // パネルを可視化
          characterPanel.setAttribute('visible', 'true');
          
          // ar-hit-testを無効化して、パネルの位置を固定
          sceneEl.setAttribute('ar-hit-test', { enabled: false });
          
          // ローディング画面を非表示
          const loader = document.querySelector('.arjs-loader');
          if(loader) {
            loader.style.display = 'none';
          }
        }
      });
    });
  </script>
</body>
</html>
